---
title: 数据库索引
author: Yu Mengchi
categories:
  - Interview 
  - 面试知识点
  - 数据库
tags:
  - Interview
  - DataBase
---

---
### MySQL有哪些索引？
1. **主键索引**:每张表只能有一个主键；一种特殊的唯一索引，要求索引列的值唯一且非空(所以一般使用自增)；InnoDB使用主键作为聚簇索引的基础；
2. **唯一索引**:索引列的值唯一，但允许有空值；一个表可以有多个唯一索引；
3. **普通索引**:最基本的索引类型，没有任何限制条件；适用于加速查询操作；
4. 全文索引:专门用于全文索引，支持复杂的文本匹配查询；适用于大文本字段，比如varchar、text
5. 联合索引:组合索引或复合索引，在多个列上创建的一个索引；创建时需要注意索引列的顺序；通过对多个列创建索引优化查询性能，查询条件涉及多个列的时候；
6. 空间索引:用于地理空间数据类型Geometry类型的索引
7. 覆盖索引:不是一个独立的索引类型，指的是一个索引如果包含了查询所需的所有列，则可以直接从索引中获取数据而无需访问表的数据行。通过索引直接提供查询所需的所有数据

```roomsql
CREATE UNIQUE INDEX ON TABLE_NAME (COL1,COL2...);
CREATE INDEX ON TABLE_NAME (COL1,COL2...);
```

> 一个组合索引也可以同时是一个覆盖索引，两者并不互斥；

---
### 覆盖索引有什么优点
覆盖索引就是指查找的时候，需要查找的字段可以在索引中直接返回，不用从磁盘中读取。这样mysql可以只通过索引就能返回需要的数据，性能比较快。

---
### 什么是聚簇索引？
聚簇索引将数据存储在索引中，而不是独立的数据页中。可以提高查询效率
- 聚簇索引通常基于主键；
- 如果表没有主键，InnoDB会选择一个唯一的非空列作为聚簇索引；如果连这样的列都没有，InnoDB会隐式创建一个6字节的ROWID作为主键；

InnoDB中的聚簇索引：
- 非叶子节点：存储索引键值以及指向叶子节点的指针。这些节点不存储实际的数据行，只用于定位数据；
- 叶子节点：存储索引键值以及对应的实际数据行(完整数据记录)。每个叶子节点还包含指向相邻叶子节点的指针，用于支持范围查询；

聚簇索引特点：
- 数据按主键排序：表中的数据行按照主键的顺序存储，因此通过主键访问数据时非常高效；
- 快速范围查询：
- 主键唯一性：主键必须唯一，因为它是聚簇索引的键值。

聚簇索引的优势：
- 数据访问高效:数据行直接存储在B+树的叶子节点上，通过主键访问数据只需一次B+树查找
- 范围查询快速:
- B+树高度较低，减少了磁盘IO次数

聚簇索引的缺点：
- 如果主键频繁更新，会导致重新组织聚簇索引，增加维护成本；主键应尽量选择单调递增的值(比如自增ID);
- 通过辅助索引查询数据时，需要先找到主键值，再通过聚簇索引查找实际数据。

---
### 使用索引应该注意什么？
哪些字段适合做索引？
- 经常查询的字段
- 不为null的字段
- 被作为where条件查询的字段
- 被频繁用来连接的字段

使用索引应该注意什么？
- 经常更新的字段不应该作为索引
- 每张表最好不超过5个索引，因为mysql优化器会选择最佳的执行计划，会耗时
- 尽可能建组合索引(联合索引)，组合索引要特别注意列的顺序，最常用于查询条件的列应该放在前面；**最左匹配原则**
- 避免**索引失效**

---
### 什么情况下索引会失效？
- 使用select * ,如果一个查询返回表中大部分的数据行，MySQL优化器会认为**全表扫描比使用索引更高效**
- 创建了联合索引但是查询条件未遵循**最左匹配原则** (联合索引使用or连接也不行)
- 在索引列上进行计算，**使用函数、类型转换、数学运算**等操作
- **以通配符开头的like查询**，比如以%或_开头；
- 使用or的时候，如果有一个字段没有索引，会导致其他字段的索引失效
- 发生**隐式类型转换**（操作符两边数据类型不一样，或字符集不一样，比如一定要用双引号表明是字符串：where name="lijia"）

---
### 什么是最左匹配规则？
是指在使用联合索引时，查询条件中的列必须按照索引中定义的顺序从左到右匹配，至少要包含联合索引的第一个列。

---
### 联合索引为什么有最左匹配规则？
- 主要是由B+树工作的原理决定的，建一个联合索引实际上是创建了一个基于多个字段组合的B+树。这个树首先根据第一个字段排序，第一个字段值相同再根据第二个字段排序，所以在查找的时候，如果缺少了前面的字段，就无法确定后续字段的具体位置，所以就不能利用到联合索引定位了。

设计联合索引的原则：
1. 最左边的列通常是选择性更高的列，这个列的不同值的数量更多，这样可以在早期阶段过滤掉大量不符合条件的记录，提高查询效率。
2. 尽量使用索引覆盖，就是查询的所有字段都可以通过索引获得，数据库可以直接从索引中获取所需的信息，不需要访问表数据本身，查询速度更快。

---
### 联合索引的B+树索引是怎么设置存储的？
非叶子节点是第一个索引的顺序，在叶子节点上data域是按每个索引的顺序排列。并且叶子节点上存放对应的主键记录的地址。

---
### 联合索引什么时候失效？
1. 没有遵循最左匹配原则
2. 用or连接

---
### 联合索引是怎么查找的？
查找元素时，会先比较第一个列的值，如果相同则再比较第二个列的值。

---
### B+树定义？结构？特点？
B+树是一种平衡的多路搜索树，主要用在数据库和文件系统中作为索引结构，可以减少磁盘IO操作次数，提高查询效率。

---
### InnoDB存储引擎底层使用的数据结构是什么？B+树有什么特点？为什么使用B+树？
B+树

B+树特点：
1. 所有数据都在叶子节点上：非叶子节点只存储键值和指向下一个节点的指针；
2. 叶子节点之间有链接：B+树的叶子节点是顺序连接的，通常是双向链表，可以方便地实现范围查询；
3. B+树每个节点有很多子节点，减少了树的高度。减少了磁盘IO次数；
4. 平衡树结构：从根节点到任何一个叶子节点的距离都是相同的，确保每次查找、插入或删除的时间复杂度都是O(logn).

为什么使用B+树：
1. 优化磁盘IO性能：减少了磁盘IO操作的次数；
2. 支持高效的范围查询：叶子节点顺序相连；

为什么使用B+树不适用跳表？(从空间效率和磁盘IO性能，并发控制来讲)

---
### B+树索引结构的工作原理
1. B+树的每个节点都有关键字列表，关键字列表按顺序排列，每个节点都有2个以上的子树，关键字左子树中的关键字都小于该关键字，右子树中的关键字都大于等于该关键字；
2. 非叶子节点只存放关键字，叶子节点存放关键字和data记录
3. 叶子节点之间用指针连接，所有叶子节点的关键字按关键字大小顺序排序。

查找的时候：可以从最左边的叶子节点开始顺序查找，也可以从根节点开始自上而下查找；

插入操作时，从叶子节点开始查找插入位置，并且判断所插入节点的关键字数量是不是超过了规定的数量，如果超过了，需要分裂成两个节点。

---
### 主键索引和其他辅助索引在B+树上有什么不同？
1. 主键索引：不重复(唯一)、不为空的列；如果没有指定，InnoDB会自动生成一个隐藏列作为主键索引
- 叶子节点存放的是索引键值和数据行的所有列数据
2. 辅助索引：可以重复(除非是唯一索引)；
- 叶子节点是索引键值和对应的主键值，不是整行数据，根据这个主键值去主键索引查找完整数据行，这种两次查找的过程称为"回表".

---
### 数据库B+树高度和入度计算
树的高度h与**总节点数N**和**阶数n**有关。

阶数为n(即每个节点最多有n个子节点)，总节点为N，则高度h=以n为底，N的对数；

---
### 索引下推
索引下推是一种查询优化技术。把过滤和排序操作放在数据库引擎中的存储引擎层级来执行，而不是在查询过程中将整个数据集传输到查询引擎层级来处理。
可以减少数据传输和处理的时间，提高查询性能。

当查询条件里有某个索引的条件时候，会先在索引的遍历过程中提前过滤



